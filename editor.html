<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¾™é«˜åŒ—é‡å¼€æ¨¡æ‹Ÿå™¨ - é«˜çº§å†…å®¹ç¼–è¾‘å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      line-height: 1.6;
    }

    .header {
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .header h1 {
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary { background-color: #4a90e2; color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-warning { background-color: #ffc107; color: #333; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-info { background-color: #17a2b8; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .btn-sm { padding: 5px 10px; font-size: 12px; }

    .main-container {
      display: flex;
      min-height: calc(100vh - 60px);
    }

    .sidebar {
      width: 240px;
      background-color: white;
      border-right: 1px solid #e0e0e0;
      padding: 15px 0;
      overflow-y: auto;
    }

    .sidebar-title {
      padding: 0 15px 10px;
      font-size: 12px;
      color: #666;
      font-weight: bold;
      text-transform: uppercase;
    }

    .nav-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border-left: 3px solid transparent;
      font-size: 14px;
    }

    .nav-item:hover { background-color: #f5f5f5; }
    .nav-item.active { background-color: #e3f2fd; border-left-color: #4a90e2; color: #1a237e; font-weight: 500; }
    .nav-icon { font-size: 16px; }

    .content-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .section { display: none; }
    .section.active { display: block; }

    .section-title {
      font-size: 18px;
      color: #1a237e;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #4a90e2;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .edit-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .edit-card-title {
      font-size: 15px;
      color: #1a237e;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 6px;
      background-color: #e3f2fd;
      color: #1976d2;
      border-radius: 10px;
      font-weight: normal;
    }

    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #555;
      font-size: 12px;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74,144,226,0.2);
    }

    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .form-row-2 { grid-template-columns: 1fr 1fr; }

    .array-item {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 8px;
      border-left: 3px solid #4a90e2;
    }

    .array-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .array-item-title { font-weight: 500; color: #333; font-size: 14px; }

    .status-bar {
      background-color: #333;
      color: white;
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .status-indicator { display: flex; align-items: center; gap: 6px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #4caf50; }
    .status-dot.unsaved { background-color: #ff9800; }

    .search-box {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .search-box input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-title { font-size: 16px; color: #1a237e; margin-bottom: 15px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: #333;
      color: white;
      border-radius: 8px;
      z-index: 1001;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #28a745; }
    .toast.warning { background-color: #ffc107; color: #333; }
    .toast.error { background-color: #dc3545; }

    .effect-builder {
      background-color: #f0f4f8;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .effect-item {
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .effect-type-select {
      width: 120px;
      flex-shrink: 0;
    }

    .effect-field-select {
      width: 120px;
    }

    .effect-value-input {
      width: 80px;
    }

    .effect-remove {
      margin-left: auto;
      color: #dc3545;
      cursor: pointer;
      font-size: 18px;
    }

    .timeline-preview {
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .timeline-preview h4 {
      color: #2e7d32;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .timeline-event-item {
      display: flex;
      align-items: center;
      padding: 8px;
      background-color: white;
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .timeline-event-date {
      background-color: #4a90e2;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 10px;
      white-space: nowrap;
    }

    .timeline-event-countdown {
      margin-left: auto;
      color: #ff9800;
      font-weight: 500;
    }

    .highschool-card {
      display: flex;
      align-items: center;
      padding: 12px;
      background-color: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .highschool-score {
      background-color: #4a90e2;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
      margin-right: 12px;
    }

    .highschool-info { flex: 1; }
    .highschool-name { font-weight: 500; color: #333; }
    .highschool-features { font-size: 12px; color: #666; margin-top: 2px; }

    .exam-config-card {
      background-color: #fff3e0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #ff9800;
    }

    .exam-config-card h4 {
      color: #e65100;
      margin-bottom: 10px;
    }

    .condition-builder {
      background-color: #fce4ec;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .condition-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 15px;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover { background-color: #f5f5f5; }
    .tab.active {
      border-bottom-color: #4a90e2;
      color: #1a237e;
      font-weight: 500;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .filter-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .filter-tag {
      padding: 4px 10px;
      background-color: #e3f2fd;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tag:hover, .filter-tag.active {
      background-color: #4a90e2;
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon { font-size: 48px; margin-bottom: 10px; }
  </style>
</head>

<body>
  <header class="header">
    <h1>ğŸ“ é¾™é«˜åŒ—é‡å¼€æ¨¡æ‹Ÿå™¨ - é«˜çº§å†…å®¹ç¼–è¾‘å™¨</h1>
  <div class="header-actions">
    <button class="btn btn-info" onclick="showBackups()">å¤‡ä»½ç®¡ç†</button>
    <button class="btn btn-secondary" onclick="importConfig()">å¯¼å…¥é…ç½®</button>
    <button class="btn btn-warning" onclick="resetToDefault()">é‡ç½®é»˜è®¤</button>
    <button class="btn btn-primary" onclick="exportConfig()">å¯¼å‡ºJSON</button>
    <button class="btn btn-success" onclick="saveConfig()">ä¿å­˜å¹¶åº”ç”¨</button>
  </div>
  </header>

  <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(event)">

  <div class="main-container">
    <nav class="sidebar">
      <div class="sidebar-title">å†…å®¹ç®¡ç†</div>
      <div class="nav-item active" onclick="showSection('basic')">
        <span class="nav-icon">ğŸ®</span><span>åŸºç¡€è®¾ç½®</span>
      </div>
      <div class="nav-item" onclick="showSection('randomEvents')">
        <span class="nav-icon">ğŸ²</span><span>éšæœºäº‹ä»¶</span>
      </div>
      <div class="nav-item" onclick="showSection('timeline')">
        <span class="nav-icon">ğŸ“…</span><span>æ—¶é—´çº¿äº‹ä»¶</span>
      </div>
      <div class="nav-item" onclick="showSection('achievements')">
        <span class="nav-icon">ğŸ†</span><span>æˆå°±ç³»ç»Ÿ</span>
      </div>
      <div class="nav-item" onclick="showSection('endings')">
        <span class="nav-icon">ğŸ“</span><span>ç»“å±€è®¾ç½®</span>
      </div>
      <div class="nav-item" onclick="showSection('highschools')">
        <span class="nav-icon">ğŸ«</span><span>é«˜ä¸­åˆ†æ•°çº¿</span>
      </div>
      <div class="nav-item" onclick="showSection('examConfig')">
        <span class="nav-icon">ğŸ“</span><span>è€ƒè¯•æœºåˆ¶</span>
      </div>
      <div class="nav-item" onclick="showSection('effects')">
        <span class="nav-icon">âš¡</span><span>æ•ˆæœç±»å‹</span>
      </div>
      <div class="nav-item" onclick="showSection('quotes')">
        <span class="nav-icon">ğŸ’¬</span><span>è¯­å½•ç®¡ç†</span>
      </div>
      <div class="sidebar-title" style="margin-top: 15px;">å·¥å…·</div>
      <div class="nav-item" onclick="showSection('preview')">
        <span class="nav-icon">ğŸ‘ï¸</span><span>äº‹ä»¶é¢„å‘Šé¢„è§ˆ</span>
      </div>
    </nav>

    <main class="content-area">
      <section id="section-basic" class="section active">
        <h2 class="section-title">ğŸ® åŸºç¡€æ¸¸æˆè®¾ç½®</h2>
        <div class="edit-card">
          <div class="edit-card-title">æ¸¸æˆä¿¡æ¯</div>
          <div class="form-row">
            <div class="form-group">
              <label>æ¸¸æˆæ ‡é¢˜</label>
              <input type="text" id="game-title" onchange="updateGameInfo('title', this.value)">
            </div>
            <div class="form-group">
              <label>æ¸¸æˆå‰¯æ ‡é¢˜</label>
              <input type="text" id="game-subtitle" onchange="updateGameInfo('subtitle', this.value)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>å­¦æ ¡åç§°</label>
              <input type="text" id="school-name" onchange="updateGameInfo('schoolName', this.value)">
            </div>
            <div class="form-group">
              <label>é«˜ä¸­åç§°</label>
              <input type="text" id="highschool-name" onchange="updateGameInfo('highSchoolName', this.value)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>å¼€å§‹å¹´ä»½</label>
              <input type="number" id="start-year" onchange="updateGameInfo('startYear', parseInt(this.value))">
            </div>
            <div class="form-group">
              <label>ç»“æŸå¹´ä»½</label>
              <input type="number" id="end-year" onchange="updateGameInfo('endYear', parseInt(this.value))">
            </div>
          </div>
        </div>
      </section>

      <section id="section-randomEvents" class="section">
        <h2 class="section-title">
          ğŸ² éšæœºäº‹ä»¶ç®¡ç†
          <button class="btn btn-success btn-sm" onclick="openEventModal()">+ æ·»åŠ äº‹ä»¶</button>
        </h2>
        <div class="search-box">
          <input type="text" id="event-search" placeholder="æœç´¢äº‹ä»¶IDæˆ–æ ‡é¢˜..." oninput="filterEvents()">
        </div>
        <div class="filter-tags" id="event-filters">
          <span class="filter-tag active" data-filter="all" onclick="filterEventsByTag('all')">å…¨éƒ¨</span>
          <span class="filter-tag" data-filter="academic" onclick="filterEventsByTag('academic')">å­¦ä¸š</span>
          <span class="filter-tag" data-filter="social" onclick="filterEventsByTag('social')">ç¤¾äº¤</span>
          <span class="filter-tag" data-filter="status" onclick="filterEventsByTag('status')">çŠ¶æ€</span>
        </div>
        <div id="events-list"></div>
      </section>

      <section id="section-timeline" class="section">
        <h2 class="section-title">
          ğŸ“… æ—¶é—´çº¿äº‹ä»¶ç®¡ç†
          <button class="btn btn-success btn-sm" onclick="openTimelineModal()">+ æ·»åŠ äº‹ä»¶</button>
        </h2>
        <div class="timeline-preview">
          <h4>ğŸ“Œ å³å°†åˆ°æ¥çš„äº‹ä»¶ï¼ˆé¢„å‘Šç³»ç»Ÿé¢„è§ˆï¼‰</h4>
          <div id="timeline-preview-list"></div>
        </div>
        <div class="search-box">
          <input type="text" id="timeline-search" placeholder="æœç´¢æ—¶é—´çº¿äº‹ä»¶..." oninput="filterTimelineEvents()">
        </div>
        <div class="filter-tags" id="timeline-filters">
          <span class="filter-tag active" data-filter="all" onclick="filterTimelineByTag('all')">å…¨éƒ¨</span>
          <span class="filter-tag" data-filter="key" onclick="filterTimelineByTag('key')">å…³é”®äº‹ä»¶</span>
          <span class="filter-tag" data-filter="exam" onclick="filterTimelineByTag('exam')">è€ƒè¯•</span>
          <span class="filter-tag" data-filter="holiday" onclick="filterTimelineByTag('holiday')">å‡æœŸ</span>
          <span class="filter-tag" data-filter="activity" onclick="filterTimelineByTag('activity')">æ´»åŠ¨</span>
        </div>
        <div id="timeline-list"></div>
      </section>

      <section id="section-achievements" class="section">
        <h2 class="section-title">
          ğŸ† æˆå°±ç³»ç»Ÿç®¡ç†
          <button class="btn btn-success btn-sm" onclick="openAchievementModal()">+ æ·»åŠ æˆå°±</button>
        </h2>
        <div id="achievements-list"></div>
      </section>

      <section id="section-endings" class="section">
        <h2 class="section-title">
          ğŸ“ ç»“å±€è®¾ç½®ç®¡ç†
          <button class="btn btn-success btn-sm" onclick="openEndingModal()">+ æ·»åŠ ç»“å±€</button>
        </h2>
        <div id="endings-list"></div>
      </section>

      <section id="section-highschools" class="section">
        <h2 class="section-title">
          ğŸ« æ·±åœ³é«˜ä¸­åˆ†æ•°çº¿ç®¡ç†
          <button class="btn btn-success btn-sm" onclick="openHighschoolModal()">+ æ·»åŠ å­¦æ ¡</button>
        </h2>
        <div class="search-box">
          <input type="text" id="highschool-search" placeholder="æœç´¢å­¦æ ¡..." oninput="filterHighschools()">
        </div>
        <div id="highschools-list"></div>
      </section>

      <section id="section-examConfig" class="section">
        <h2 class="section-title">ğŸ“ è€ƒè¯•æœºåˆ¶é…ç½®</h2>
        <div class="exam-config-card">
          <h4>ğŸ“Š åˆ†æ•°è®¡ç®—é…ç½®</h4>
          <div class="form-row">
            <div class="form-group">
              <label>åŸºç¡€åˆ†æ•°</label>
              <input type="number" id="base-score" onchange="updateExamConfig('baseScore', parseInt(this.value))">
            </div>
          </div>
          <div class="form-group">
            <label>éš¾åº¦ç³»æ•°ï¼ˆJSONæ ¼å¼ï¼‰</label>
            <textarea id="difficulty-config" style="min-height: 60px;" onchange="updateDifficultyConfig()"></textarea>
          </div>
          <div class="form-group">
            <label>åˆ†æ•°åŠ æˆï¼ˆJSONæ ¼å¼ï¼‰</label>
            <textarea id="bonus-config" style="min-height: 80px;" onchange="updateBonusConfig()"></textarea>
          </div>
        </div>
        <div class="exam-config-card">
          <h4>â±ï¸ æ—¶é—´é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰</h4>
          <div class="form-row" id="time-limit-config"></div>
        </div>
        <div class="exam-config-card">
          <h4>ğŸ“± ç‚¹å‡»æ¬¡æ•°é™åˆ¶</h4>
          <div class="form-group" style="margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <label>ç»Ÿä¸€è®¾ç½®æ‰€æœ‰è€ƒè¯•ç±»å‹çš„ç‚¹å‡»æ¬¡æ•°:</label>
              <input type="number" id="unified-click-limit" placeholder="è¾“å…¥ç»Ÿä¸€ç‚¹å‡»æ¬¡æ•°" style="width: 150px;">
              <button class="btn btn-primary btn-sm" onclick="applyUnifiedClickLimit()">åº”ç”¨ç»Ÿä¸€è®¾ç½®</button>
            </div>
          </div>
          <div class="form-row" id="click-limit-config"></div>
        </div>
        <div class="exam-config-card">
          <h4>ğŸ“ˆ åˆ†æ•°æƒé‡</h4>
          <div class="form-row" id="score-weight-config"></div>
        </div>
        <div class="exam-config-card">
          <h4>ğŸŒ§ï¸ è€ƒè¯•å–æ¶ˆæ¡ä»¶</h4>
          <div class="form-group">
            <label>å¤©æ°”ç±»å‹ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input type="text" id="cancel-weather" onchange="updateCancelWeather()">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="cancel-holiday" onchange="updateCancelHoliday()"> å‡æ—¥è‡ªåŠ¨å–æ¶ˆ
            </label>
          </div>
        </div>
      </section>

      <section id="section-effects" class="section">
        <h2 class="section-title">âš¡ æ•ˆæœç±»å‹é…ç½®</h2>
        <div id="effects-list"></div>
      </section>

      <section id="section-quotes" class="section">
        <h2 class="section-title">
          ğŸ’¬ è¯­å½•ç®¡ç†
          <button class="btn btn-success btn-sm" onclick="openQuoteModal()">+ æ·»åŠ è¯­å½•</button>
        </h2>
        <div class="edit-card">
          <div class="edit-card-title">ğŸ“Š è¯­å½•ç»Ÿè®¡</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #1976d2;" id="default-quotes-count">0</div>
              <div style="font-size: 12px; color: #666;">é»˜è®¤è¯­å½•</div>
            </div>
          </div>
        </div>
        <div id="quotes-list"></div>
        
        <div class="edit-card" style="margin-top: 15px;">
          <div class="edit-card-title">ğŸ“Œ æ¥ä¸‹æ¥3ä¸ªå³å°†å‘ç”Ÿçš„äº‹ä»¶</div>
          <div id="upcoming-events-preview"></div>
        </div>
        <div class="edit-card">
          <div class="edit-card-title">ğŸ“Š äº‹ä»¶ç»Ÿè®¡</div>
          <div id="event-stats"></div>
        </div>
      </section>

      <section id="section-preview" class="section">
        <h2 class="section-title">ğŸ‘ï¸ äº‹ä»¶é¢„å‘Šç³»ç»Ÿé¢„è§ˆ</h2>
        <div class="edit-card">
          <div class="edit-card-title">ğŸ“Œ æ¥ä¸‹æ¥3ä¸ªå³å°†å‘ç”Ÿçš„äº‹ä»¶</div>
          <div id="upcoming-events-preview-full"></div>
        </div>
        <div class="edit-card">
          <div class="edit-card-title">ğŸ“Š äº‹ä»¶ç»Ÿè®¡</div>
          <div id="event-stats-full"></div>
        </div>
      </section>
    </main>
  </div>

  <footer class="status-bar">
    <div class="status-indicator">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">å·²ä¿å­˜</span>
    </div>
    <div>ç‰ˆæœ¬: <span id="config-version"></span> | é…ç½®å¯¹è±¡æ•°: <span id="config-count">0</span></div>
  </footer>

  <div class="modal" id="event-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="event-modal-title">æ·»åŠ éšæœºäº‹ä»¶</h3>
      <div id="event-modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('event-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveEvent()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="timeline-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="timeline-modal-title">æ·»åŠ æ—¶é—´çº¿äº‹ä»¶</h3>
      <div id="timeline-modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('timeline-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTimelineEvent()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="achievement-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="achievement-modal-title">æ·»åŠ æˆå°±</h3>
      <div id="achievement-modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('achievement-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveAchievement()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="ending-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="ending-modal-title">æ·»åŠ ç»“å±€</h3>
      <div id="ending-modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('ending-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveEnding()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="highschool-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="highschool-modal-title">æ·»åŠ é«˜ä¸­</h3>
      <div id="highschool-modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('highschool-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveHighschool()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="effect-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="effect-modal-title">æ·»åŠ æ•ˆæœ</h3>
      <div id="effect-modal-content"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('effect-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveEffect()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="reset-modal">
    <div class="modal-content">
      <h3 class="modal-title">ç¡®è®¤é‡ç½®</h3>
      <p>ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿå½“å‰ä¿®æ”¹å°†ä¼šä¸¢å¤±ã€‚</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('reset-modal')">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="confirmReset()">ç¡®å®šé‡ç½®</button>
      </div>
    </div>
  </div>

  <div class="modal" id="backups-modal">
    <div class="modal-content" style="max-width: 800px;">
      <h3 class="modal-title">å¤‡ä»½ç®¡ç†</h3>
      <div id="backups-list"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('backups-modal')">å…³é—­</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="quote-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="quote-modal-title">æ·»åŠ è¯­å½•</h3>
      <div class="form-group">
        <label>è¯­å½•å†…å®¹</label>
        <textarea id="quote-content" style="min-height: 80px;" placeholder="è¯·è¾“å…¥è¯­å½•å†…å®¹..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('quote-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveQuote()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    let contentConfig = {};
    let originalConfig = {};
    let isUnsaved = false;
    let editingEventId = null;
    let editingTimelineId = null;
    let editingAchievementId = null;
    let editingEndingId = null;
    let editingHighschoolId = null;

    const EFFECTS_CONFIG = {
      academic: { label: 'å­¦ä¸šæˆç»©', fields: ['subjects', 'value', 'mode'], subjects: ['chinese', 'math', 'english', 'politics', 'history', 'physics', 'chemistry', 'biology', 'geography', 'sports'] },
      abilities: { label: 'èƒ½åŠ›å±æ€§', fields: ['field', 'value'], fieldsList: ['memory', 'comprehension', 'focus', 'mindset'] },
      status: { label: 'çŠ¶æ€å±æ€§', fields: ['field', 'value'], fieldsList: ['physical', 'energy', 'stress'] },
      special: { label: 'ç‰¹æ®Šå±æ€§', fields: ['field', 'value'], fieldsList: ['lastStand', 'survival', 'romance', 'highSchoolSigned', 'socialDesire'] },
      classmateship: { label: 'åŒå­¦å…³ç³»', fields: ['value'] },
      dormmates: { label: 'èˆå‹å…³ç³»', fields: ['value'] },
      teachers: { label: 'å¸ˆç”Ÿå…³ç³»', fields: ['value'] },
      clubExperience: { label: 'ç¤¾å›¢ç»éªŒ', fields: ['value'] },
      club: { label: 'åŠ å…¥ç¤¾å›¢', fields: ['value'] }
    };

    const CONDITION_TYPES = {
      status: { label: 'çŠ¶æ€æ¡ä»¶', fields: ['field', 'operator', 'value'], fieldsList: ['physical', 'energy', 'stress'] },
      academic: { label: 'å­¦ä¸šæ¡ä»¶', fields: ['field', 'operator', 'value'], subjects: ['chinese', 'math', 'english'] },
      phase: { label: 'é˜¶æ®µæ¡ä»¶', fields: ['values'], phases: ['MONTHLY_EXAM', 'MIDTERM', 'FINAL', 'ENTRY_EXAM', 'BIOLOGY_GEOGRAPHY', 'MOCK', 'MIDDLE_EXAM', 'SPORTS_EXAM'] },
      club: { label: 'ç¤¾å›¢æ¡ä»¶', fields: ['value'] },
      flag: { label: 'æ ‡è®°æ¡ä»¶', fields: ['field', 'value'] }
    };

    async function init() {
      await loadConfig();
      renderAllSections();
      updateStatusBar();
    }

    async function loadConfig() {
      try {
        const response = await fetch('content-config.json');
        contentConfig = await response.json();
        originalConfig = JSON.parse(JSON.stringify(contentConfig));
      } catch (e) {
        console.log('ä½¿ç”¨å†…ç½®é»˜è®¤é…ç½®');
        contentConfig = getDefaultConfig();
      }
    }

    function getDefaultConfig() {
      return {
        version: "2.0.0",
        lastUpdated: new Date().toISOString().split('T')[0],
        game: { title: "é¾™é«˜åŒ—é‡å¼€æ¨¡æ‹Ÿå™¨", subtitle: "åˆä¸­ä¸‰å¹´ï¼Œé‡æ–°æ¥è¿‡", schoolName: "é¾™åŸä¸­å­¦", highSchoolName: "é¾™åŸé«˜çº§ä¸­å­¦", startYear: 2022, endYear: 2025 },
        events: { random: [] },
        timeline: { events: [] },
        achievements: [],
        endings: [],
        highSchools: { data: [] },
        examMechanics: { scoreCalculation: { baseScore: 100, difficulty: {}, bonus: {} }, timeLimit: {}, scoreWeight: {}, cancelConditions: { weather: [], holiday: false } },
        effects: {},
        quotes: {
          default: [
            'å­¦ä¹ å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€‚',
            'å®å‰‘é”‹ä»ç£¨ç ºå‡ºï¼Œæ¢…èŠ±é¦™è‡ªè‹¦å¯’æ¥ã€‚',
            'ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸã€‚',
            'ä¸šç²¾äºå‹¤ï¼Œè’äºå¬‰ï¼›è¡Œæˆäºæ€ï¼Œæ¯äºéšã€‚',
            'å°‘å£®ä¸åŠªåŠ›ï¼Œè€å¤§å¾’ä¼¤æ‚²ã€‚',
            'å®å‰‘é”‹ä»ç£¨ç ºå‡ºï¼Œæ¢…èŠ±é¦™è‡ªè‹¦å¯’æ¥ã€‚',
            'è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ã€‚',
            'ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œï¼›ä¸ç§¯å°æµï¼Œæ— ä»¥æˆæ±Ÿæµ·ã€‚',
            'å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚',
            'çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚ä¹ä¹‹è€…ã€‚',
            'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿ',
            'æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œå¯ä»¥ä¸ºå¸ˆçŸ£ã€‚',
            'ä¸‰äººè¡Œï¼Œå¿…æœ‰æˆ‘å¸ˆç„‰ã€‚',
            'å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæ€è€Œä¸å­¦åˆ™æ®†ã€‚',
            'è¯»ä¹¦ç ´ä¸‡å·ï¼Œä¸‹ç¬”å¦‚æœ‰ç¥ã€‚'
          ],
          custom: []
        }
      };
    }

    function renderAllSections() {
      renderBasicSection();
      renderEventsSection();
      renderTimelineSection();
      renderAchievementsSection();
      renderEndingsSection();
      renderHighschoolsSection();
      renderExamConfigSection();
      renderEffectsSection();
      renderQuotesSection();
      renderPreviewSection();
    }

    function renderBasicSection() {
      document.getElementById('game-title').value = contentConfig.game?.title || '';
      document.getElementById('game-subtitle').value = contentConfig.game?.subtitle || '';
      document.getElementById('school-name').value = contentConfig.game?.schoolName || '';
      document.getElementById('highschool-name').value = contentConfig.game?.highSchoolName || '';
      document.getElementById('start-year').value = contentConfig.game?.startYear || 2022;
      document.getElementById('end-year').value = contentConfig.game?.endYear || 2025;
    }

    function renderEventsSection() {
      const container = document.getElementById('events-list');
      container.innerHTML = '';
      const events = contentConfig.events?.random || [];
      if (events.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æš‚æ— éšæœºäº‹ä»¶ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
        return;
      }
      events.forEach((event, index) => {
        const card = document.createElement('div');
        card.className = 'edit-card';
        card.dataset.id = event.id;
        card.dataset.type = getEventType(event);
        card.innerHTML = `
          <div class="array-item-header">
            <span class="array-item-title">ğŸ“– ${event.title || event.id}</span>
            <div>
              <button class="btn btn-info btn-sm" onclick="editEvent('${event.id}')">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="deleteEvent('${event.id}')">åˆ é™¤</button>
            </div>
          </div>
          <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${event.description?.substring(0, 100)}...</div>
          <div style="font-size: 11px; color: #999;">
            è§¦å‘æ¦‚ç‡: ${event.probability || 0} | å†·å´: ${event.cooldown || 0}å¤© | é€‰é¡¹æ•°: ${event.options?.length || 0}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function getEventType(event) {
      const desc = (event.description || '').toLowerCase();
      if (desc.includes('å­¦ä¹ ') || desc.includes('è€ƒè¯•') || desc.includes('ä½œä¸š')) return 'academic';
      if (desc.includes('åŒå­¦') || desc.includes('æœ‹å‹') || desc.includes('è€å¸ˆ')) return 'social';
      if (desc.includes('å‹åŠ›') || desc.includes('ç²¾åŠ›') || desc.includes('èº«ä½“')) return 'status';
      return 'other';
    }

    function filterEvents() {
      const query = document.getElementById('event-search').value.toLowerCase();
      const cards = document.querySelectorAll('#events-list .edit-card');
      cards.forEach(card => {
        const title = card.querySelector('.array-item-title').textContent.toLowerCase();
        const visible = title.includes(query);
        card.style.display = visible ? 'block' : 'none';
      });
    }

    function filterEventsByTag(tag) {
      document.querySelectorAll('#event-filters .filter-tag').forEach(t => t.classList.remove('active'));
      document.querySelector(`#event-filters .filter-tag[data-filter="${tag}"]`).classList.add('active');
      const cards = document.querySelectorAll('#events-list .edit-card');
      cards.forEach(card => {
        if (tag === 'all') {
          card.style.display = 'block';
        } else {
          card.style.display = card.dataset.type === tag ? 'block' : 'none';
        }
      });
    }

    function openEventModal(eventId = null) {
      editingEventId = eventId;
      const modal = document.getElementById('event-modal');
      const title = document.getElementById('event-modal-title');
      const content = document.getElementById('event-modal-content');
      
      title.textContent = eventId ? 'ç¼–è¾‘éšæœºäº‹ä»¶' : 'æ·»åŠ éšæœºäº‹ä»¶';
      const event = eventId ? contentConfig.events.random.find(e => e.id === eventId) : { id: generateId('event'), title: '', description: '', triggerConditions: null, probability: 0.1, once: false, cooldown: 7, options: [] };
      
      content.innerHTML = `
        <div class="form-group">
          <label>äº‹ä»¶IDï¼ˆè‹±æ–‡ï¼Œå”¯ä¸€ï¼‰</label>
          <input type="text" id="event-id" value="${event.id}" ${eventId ? 'readonly' : ''}>
        </div>
        <div class="form-group">
          <label>äº‹ä»¶æ ‡é¢˜</label>
          <input type="text" id="event-title" value="${event.title || ''}">
        </div>
        <div class="form-group">
          <label>äº‹ä»¶æè¿°</label>
          <textarea id="event-description" style="min-height: 80px;">${event.description || ''}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>è§¦å‘æ¦‚ç‡ (0-1)</label>
            <input type="number" id="event-probability" step="0.05" min="0" max="1" value="${event.probability || 0.1}">
          </div>
          <div class="form-group">
            <label>æ˜¯å¦åªè§¦å‘ä¸€æ¬¡</label>
            <select id="event-once">
              <option value="false" ${!event.once ? 'selected' : ''}>å¦</option>
              <option value="true" ${event.once ? 'selected' : ''}>æ˜¯</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>å†·å´å¤©æ•°</label>
          <input type="number" id="event-cooldown" min="0" value="${event.cooldown || 7}">
        </div>
        <div class="form-group">
          <label>è§¦å‘æ¡ä»¶ï¼ˆJSONï¼Œå¯é€‰ï¼‰</label>
          <textarea id="event-conditions" style="min-height: 60px;" placeholder='{"type": "status", "field": "energy", "operator": ">", "value": 30}'>${event.triggerConditions ? JSON.stringify(event.triggerConditions, null, 2) : ''}</textarea>
        </div>
        <div class="form-group">
          <label>é€‰é¡¹åˆ—è¡¨</label>
          <div id="event-options-list"></div>
          <button class="btn btn-info btn-sm" style="margin-top: 8px;" onclick="addEventOption()">+ æ·»åŠ é€‰é¡¹</button>
        </div>
      `;
      
      const optionsList = document.getElementById('event-options-list');
      (event.options || []).forEach((opt, idx) => {
        renderEventOption(optionsList, opt, idx);
      });
      
      modal.classList.add('active');
    }

    function renderEventOption(container, option, index) {
      const div = document.createElement('div');
      div.className = 'array-item';
      div.dataset.index = index;
      div.innerHTML = `
        <div class="array-item-header">
          <span>é€‰é¡¹ ${index + 1}</span>
          <button class="btn btn-danger btn-sm" onclick="this.closest('.array-item').remove()">åˆ é™¤</button>
        </div>
        <div class="form-group">
          <label>é€‰é¡¹æ–‡å­—</label>
          <input type="text" class="option-text" value="${option.text || ''}">
        </div>
        <div class="form-group">
          <label>æ•ˆæœåˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰</label>
          <textarea class="option-effects" style="min-height: 60px;">${option.effects ? JSON.stringify(option.effects, null, 2) : '[]'}</textarea>
        </div>
        <div class="form-group">
          <label>åç»­äº‹ä»¶IDï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" class="option-next" value="${option.nextEvent || ''}">
        </div>
      `;
      container.appendChild(div);
    }

    function addEventOption() {
      const container = document.getElementById('event-options-list');
      const index = container.children.length;
      renderEventOption(container, { text: '', effects: [] }, index);
    }

    function saveEvent() {
      const id = document.getElementById('event-id').value;
      const title = document.getElementById('event-title').value;
      const description = document.getElementById('event-description').value;
      const probability = parseFloat(document.getElementById('event-probability').value);
      const once = document.getElementById('event-once').value === 'true';
      const cooldown = parseInt(document.getElementById('event-cooldown').value);
      
      let triggerConditions = null;
      try {
        const condText = document.getElementById('event-conditions').value.trim();
        if (condText) triggerConditions = JSON.parse(condText);
      } catch (e) {
        showToast('è§¦å‘æ¡ä»¶JSONæ ¼å¼é”™è¯¯', 'error');
        return;
      }
      
      const options = [];
      document.querySelectorAll('#event-options-list .array-item').forEach(item => {
        const text = item.querySelector('.option-text').value;
        let effects = [];
        try {
          const effText = item.querySelector('.option-effects').value.trim();
          if (effText) effects = JSON.parse(effText);
        } catch (e) {}
        const nextEvent = item.querySelector('.option-next').value;
        if (text) {
          options.push({ text, effects, ...(nextEvent ? { nextEvent } : {}) });
        }
      });
      
      const eventData = { id, title, description, triggerConditions, probability, once, cooldown, options };
      
      if (editingEventId && editingEventId !== id) {
        contentConfig.events.random = contentConfig.events.random.filter(e => e.id !== editingEventId);
      }
      
      const existingIdx = contentConfig.events.random.findIndex(e => e.id === id);
      if (existingIdx >= 0) {
        contentConfig.events.random[existingIdx] = eventData;
      } else {
        contentConfig.events.random.push(eventData);
      }
      
      closeModal('event-modal');
      renderEventsSection();
      markUnsaved();
      showToast(editingEventId ? 'äº‹ä»¶å·²æ›´æ–°' : 'äº‹ä»¶å·²æ·»åŠ ', 'success');
    }

    function editEvent(id) { openEventModal(id); }
    
    function deleteEvent(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿ')) {
        contentConfig.events.random = contentConfig.events.random.filter(e => e.id !== id);
        renderEventsSection();
        markUnsaved();
        showToast('äº‹ä»¶å·²åˆ é™¤', 'success');
      }
    }

    function renderTimelineSection() {
      const container = document.getElementById('timeline-list');
      container.innerHTML = '';
      const events = contentConfig.timeline?.events || [];
      
      renderTimelinePreview(events);
      
      if (events.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><p>æš‚æ— æ—¶é—´çº¿äº‹ä»¶ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
        return;
      }
      
      events.sort((a, b) => a.date.localeCompare(b.date)).forEach(event => {
        const card = document.createElement('div');
        card.className = 'edit-card';
        card.dataset.type = event.type || 'key';
        card.dataset.id = event.id;
        card.innerHTML = `
          <div class="array-item-header">
            <span class="array-item-title">ğŸ“… ${event.title || event.id} <span class="badge">${event.date}</span></span>
            <div>
              <button class="btn btn-info btn-sm" onclick="editTimelineEvent('${event.id}')">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="deleteTimelineEvent('${event.id}')">åˆ é™¤</button>
            </div>
          </div>
          <div style="font-size: 12px; color: #666;">${event.description?.substring(0, 80)}...</div>
          <div style="font-size: 11px; color: #999; margin-top: 5px;">
            ç±»å‹: ${event.type} | å¹´çº§: ${event.grade} | å­¦æœŸ: ${event.semester}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderTimelinePreview(events) {
      const container = document.getElementById('timeline-preview-list');
      container.innerHTML = '';
      const sorted = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));
      const today = '2022-09-01';
      
      sorted.filter(e => e.date >= today).slice(0, 5).forEach(event => {
        const div = document.createElement('div');
        div.className = 'timeline-event-item';
        div.innerHTML = `
          <span class="timeline-event-date">${event.date}</span>
          <span>${event.title}</span>
        `;
        container.appendChild(div);
      });
    }

    function filterTimelineEvents() {
      const query = document.getElementById('timeline-search').value.toLowerCase();
      const cards = document.querySelectorAll('#timeline-list .edit-card');
      cards.forEach(card => {
        const title = card.querySelector('.array-item-title').textContent.toLowerCase();
        card.style.display = title.includes(query) ? 'block' : 'none';
      });
    }

    function filterTimelineByTag(tag) {
      document.querySelectorAll('#timeline-filters .filter-tag').forEach(t => t.classList.remove('active'));
      document.querySelector(`#timeline-filters .filter-tag[data-filter="${tag}"]`).classList.add('active');
      const cards = document.querySelectorAll('#timeline-list .edit-card');
      cards.forEach(card => {
        card.style.display = tag === 'all' || card.dataset.type === tag ? 'block' : 'none';
      });
    }

    function openTimelineModal(eventId = null) {
      editingTimelineId = eventId;
      const modal = document.getElementById('timeline-modal');
      const title = document.getElementById('timeline-modal-title');
      const content = document.getElementById('timeline-modal-content');
      
      title.textContent = eventId ? 'ç¼–è¾‘æ—¶é—´çº¿äº‹ä»¶' : 'æ·»åŠ æ—¶é—´çº¿äº‹ä»¶';
      const event = eventId ? contentConfig.timeline.events.find(e => e.id === eventId) : { 
        id: generateId('timeline'), title: '', description: '', date: '', type: 'key', grade: 1, semester: 1 
      };
      
      content.innerHTML = `
        <div class="form-group">
          <label>äº‹ä»¶ID</label>
          <input type="text" id="timeline-id" value="${event.id}" ${eventId ? 'readonly' : ''}>
        </div>
        <div class="form-group">
          <label>äº‹ä»¶æ ‡é¢˜</label>
          <input type="text" id="timeline-title" value="${event.title || ''}">
        </div>
        <div class="form-group">
          <label>äº‹ä»¶æè¿°</label>
          <textarea id="timeline-description" style="min-height: 60px;">${event.description || ''}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>æ—¥æœŸ (YYYY-MM-DD)</label>
            <input type="date" id="timeline-date" value="${event.date}">
          </div>
          <div class="form-group">
            <label>äº‹ä»¶ç±»å‹</label>
            <select id="timeline-type">
              <option value="key" ${event.type === 'key' ? 'selected' : ''}>å…³é”®äº‹ä»¶</option>
              <option value="exam" ${event.type === 'exam' ? 'selected' : ''}>è€ƒè¯•</option>
              <option value="holiday" ${event.type === 'holiday' ? 'selected' : ''}>å‡æœŸ</option>
              <option value="activity" ${event.type === 'activity' ? 'selected' : ''}>æ´»åŠ¨</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å¹´çº§</label>
            <select id="timeline-grade">
              <option value="1" ${event.grade === 1 ? 'selected' : ''}>åˆä¸€</option>
              <option value="2" ${event.grade === 2 ? 'selected' : ''}>åˆäºŒ</option>
              <option value="3" ${event.grade === 3 ? 'selected' : ''}>åˆä¸‰</option>
            </select>
          </div>
          <div class="form-group">
            <label>å­¦æœŸ</label>
            <select id="timeline-semester">
              <option value="1" ${event.semester === 1 ? 'selected' : ''}>ä¸Šå­¦æœŸ</option>
              <option value="2" ${event.semester === 2 ? 'selected' : ''}>ä¸‹å­¦æœŸ</option>
            </select>
          </div>
        </div>
        <div id="timeline-exam-config" style="display: ${event.type === 'exam' ? 'block' : 'none'};">
          <div class="form-group">
            <label>è€ƒè¯•ç±»å‹</label>
            <select id="timeline-examType" onchange="updateSubjectCheckboxes()">
              <option value="entry" ${event.examType === 'entry' ? 'selected' : ''}>å…¥å­¦è€ƒè¯•</option>
              <option value="monthly" ${event.examType === 'monthly' ? 'selected' : ''}>æœˆè€ƒ</option>
              <option value="midterm" ${event.examType === 'midterm' ? 'selected' : ''}>æœŸä¸­è€ƒè¯•</option>
              <option value="final" ${event.examType === 'final' ? 'selected' : ''}>æœŸæœ«è€ƒè¯•</option>
              <option value="biology_geography" ${event.examType === 'biology_geography' ? 'selected' : ''}>ç”Ÿåœ°ä¼šè€ƒ</option>
              <option value="sports" ${event.examType === 'sports' ? 'selected' : ''}>ä½“è‚²ä¸­è€ƒ</option>
              <option value="mock" ${event.examType === 'mock' ? 'selected' : ''}>æ¨¡æ‹Ÿè€ƒè¯•</option>
              <option value="middle" ${event.examType === 'middle' ? 'selected' : ''}>ä¸­è€ƒ</option>
            </select>
          </div>
          <div class="form-group">
            <label>è€ƒè¯•ç§‘ç›®</label>
            <div id="subject-checkboxes-container" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; max-height: 200px; overflow-y: auto;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="chinese" ${(event.subjects && event.subjects.includes('chinese')) ? 'checked' : ''}> è¯­æ–‡
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="math" ${(event.subjects && event.subjects.includes('math')) ? 'checked' : ''}> æ•°å­¦
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="english" ${(event.subjects && event.subjects.includes('english')) ? 'checked' : ''}> è‹±è¯­
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="politics" ${(event.subjects && event.subjects.includes('politics')) ? 'checked' : ''}> æ”¿æ²»
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="history" ${(event.subjects && event.subjects.includes('history')) ? 'checked' : ''}> å†å²
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="physics" ${(event.subjects && event.subjects.includes('physics')) ? 'checked' : ''}> ç‰©ç†
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="chemistry" ${(event.subjects && event.subjects.includes('chemistry')) ? 'checked' : ''}> åŒ–å­¦
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="biology" ${(event.subjects && event.subjects.includes('biology')) ? 'checked' : ''}> ç”Ÿç‰©
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="geography" ${(event.subjects && event.subjects.includes('geography')) ? 'checked' : ''}> åœ°ç†
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="subject-checkbox" value="sports" ${(event.subjects && event.subjects.includes('sports')) ? 'checked' : ''}> ä½“è‚²
              </label>
            </div>
            <div style="margin-top: 8px;">
              <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllSubjects()">å…¨é€‰</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllSubjects()" style="margin-left: 5px;">æ¸…ç©º</button>
              <button type="button" class="btn btn-sm btn-info" onclick="invertSelection()" style="margin-left: 5px;">åé€‰</button>
            </div>
          </div>
        </div>
        <div id="timeline-options-section" style="display: ${['key', 'holiday', 'activity'].includes(event.type) ? 'block' : 'none'};">
          <div class="form-group">
            <label>é€‰é¡¹åˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼Œå¯é€‰ï¼‰</label>
            <textarea id="timeline-options" style="min-height: 60px;">${event.options ? JSON.stringify(event.options, null, 2) : '[]'}</textarea>
          </div>
        </div>
      `;
      
      document.getElementById('timeline-type').onchange = function() {
        document.getElementById('timeline-exam-config').style.display = this.value === 'exam' ? 'block' : 'none';
        document.getElementById('timeline-options-section').style.display = ['key', 'holiday', 'activity'].includes(this.value) ? 'block' : 'none';
      };
      
      modal.classList.add('active');
    }

    function saveTimelineEvent() {
      const id = document.getElementById('timeline-id').value;
      const title = document.getElementById('timeline-title').value;
      const description = document.getElementById('timeline-description').value;
      const date = document.getElementById('timeline-date').value;
      const type = document.getElementById('timeline-type').value;
      const grade = parseInt(document.getElementById('timeline-grade').value);
      const semester = parseInt(document.getElementById('timeline-semester').value);
      
      let eventData = { id, title, description, date, type, grade, semester };
      
      if (type === 'exam') {
        eventData.examType = document.getElementById('timeline-examType').value;
        // ä»å¤é€‰æ¡†è·å–é€‰ä¸­çš„ç§‘ç›®
        const selectedSubjects = [];
        const checkboxes = document.querySelectorAll('input[name="subject-checkbox"]:checked');
        checkboxes.forEach(checkbox => {
          selectedSubjects.push(checkbox.value);
        });
        eventData.subjects = selectedSubjects;
      }
      
      if (['key', 'holiday', 'activity'].includes(type)) {
        try {
          const optsText = document.getElementById('timeline-options').value.trim();
          if (optsText) eventData.options = JSON.parse(optsText);
        } catch (e) { eventData.options = []; }
      }
      
      if (editingTimelineId && editingTimelineId !== id) {
        contentConfig.timeline.events = contentConfig.timeline.events.filter(e => e.id !== editingTimelineId);
      }
      
      const existingIdx = contentConfig.timeline.events.findIndex(e => e.id === id);
      if (existingIdx >= 0) {
        contentConfig.timeline.events[existingIdx] = eventData;
      } else {
        contentConfig.timeline.events.push(eventData);
      }
      
      closeModal('timeline-modal');
      renderTimelineSection();
      markUnsaved();
      showToast(editingTimelineId ? 'æ—¶é—´çº¿äº‹ä»¶å·²æ›´æ–°' : 'æ—¶é—´çº¿äº‹ä»¶å·²æ·»åŠ ', 'success');
    }

    function editTimelineEvent(id) { openTimelineEventModal(id); }
    function openTimelineEventModal(id) { openTimelineModal(id); }
    
    function deleteTimelineEvent(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¶é—´çº¿äº‹ä»¶å—ï¼Ÿ')) {
        contentConfig.timeline.events = contentConfig.timeline.events.filter(e => e.id !== id);
        renderTimelineSection();
        markUnsaved();
        showToast('æ—¶é—´çº¿äº‹ä»¶å·²åˆ é™¤', 'success');
      }
    }

    function renderAchievementsSection() {
      const container = document.getElementById('achievements-list');
      container.innerHTML = '';
      const achievements = contentConfig.achievements || [];
      
      if (achievements.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ†</div><p>æš‚æ— æˆå°±ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
        return;
      }
      
      achievements.forEach((ach, index) => {
        const card = document.createElement('div');
        card.className = 'edit-card';
        card.innerHTML = `
          <div class="array-item-header">
            <span class="array-item-title">${ach.icon || 'ğŸ†'} ${ach.name}</span>
            <div>
              <button class="btn btn-info btn-sm" onclick="editAchievement(${index})">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="deleteAchievement(${index})">åˆ é™¤</button>
            </div>
          </div>
          <div style="font-size: 12px; color: #666;">${ach.description}</div>
          <div style="font-size: 11px; margin-top: 5px;">
            <span class="badge">${ach.rarity || 'common'}</span>
            <span style="color: #999;">æ¡ä»¶: ${JSON.stringify(ach.condition)}</span>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function openAchievementModal(index = null) {
      editingAchievementId = index;
      const modal = document.getElementById('achievement-modal');
      const title = document.getElementById('achievement-modal-title');
      const content = document.getElementById('achievement-modal-content');
      
      title.textContent = index !== null ? 'ç¼–è¾‘æˆå°±' : 'æ·»åŠ æˆå°±';
      const ach = index !== null ? contentConfig.achievements[index] : { id: generateId('ach'), name: '', description: '', condition: {}, icon: 'ğŸ†', rarity: 'common' };
      
      content.innerHTML = `
        <div class="form-group">
          <label>æˆå°±ID</label>
          <input type="text" id="ach-id" value="${ach.id}" ${index !== null ? 'readonly' : ''}>
        </div>
        <div class="form-group">
          <label>æˆå°±åç§°</label>
          <input type="text" id="ach-name" value="${ach.name || ''}">
        </div>
        <div class="form-group">
          <label>æˆå°±æè¿°</label>
          <input type="text" id="ach-desc" value="${ach.description || ''}">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å›¾æ ‡ (emoji)</label>
            <input type="text" id="ach-icon" value="${ach.icon || 'ğŸ†'}">
          </div>
          <div class="form-group">
            <label>ç¨€æœ‰åº¦</label>
            <select id="ach-rarity">
              <option value="common" ${ach.rarity === 'common' ? 'selected' : ''}>æ™®é€š</option>
              <option value="rare" ${ach.rarity === 'rare' ? 'selected' : ''}>ç¨€æœ‰</option>
              <option value="epic" ${ach.rarity === 'epic' ? 'selected' : ''}>å²è¯—</option>
              <option value="legendary" ${ach.rarity === 'legendary' ? 'selected' : ''}>ä¼ è¯´</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>è§¦å‘æ¡ä»¶ï¼ˆJSONï¼‰</label>
          <textarea id="ach-condition" style="min-height: 80px;">${JSON.stringify(ach.condition, null, 2)}</textarea>
          <div style="font-size: 11px; color: #666; margin-top: 5px;">
            æ”¯æŒç±»å‹: academic, status, phase, rank, club, social, flag, school, stat
          </div>
        </div>
      `;
      modal.classList.add('active');
    }

    function saveAchievement() {
      const id = document.getElementById('ach-id').value;
      const name = document.getElementById('ach-name').value;
      const description = document.getElementById('ach-desc').value;
      const icon = document.getElementById('ach-icon').value;
      const rarity = document.getElementById('ach-rarity').value;
      
      let condition = {};
      try {
        condition = JSON.parse(document.getElementById('ach-condition').value || '{}');
      } catch (e) {
        showToast('æ¡ä»¶JSONæ ¼å¼é”™è¯¯', 'error');
        return;
      }
      
      const achData = { id, name, description, icon, rarity, condition };
      
      if (editingAchievementId !== null) {
        contentConfig.achievements[editingAchievementId] = achData;
      } else {
        contentConfig.achievements.push(achData);
      }
      
      closeModal('achievement-modal');
      renderAchievementsSection();
      markUnsaved();
      showToast(editingAchievementId !== null ? 'æˆå°±å·²æ›´æ–°' : 'æˆå°±å·²æ·»åŠ ', 'success');
    }

    function editAchievement(index) { openAchievementModal(index); }
    
    function deleteAchievement(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆå°±å—ï¼Ÿ')) {
        contentConfig.achievements.splice(index, 1);
        renderAchievementsSection();
        markUnsaved();
        showToast('æˆå°±å·²åˆ é™¤', 'success');
      }
    }

    function renderEndingsSection() {
      const container = document.getElementById('endings-list');
      container.innerHTML = '';
      const endings = contentConfig.endings || [];
      
      if (endings.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>æš‚æ— ç»“å±€ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
        return;
      }
      
      endings.forEach((ending, index) => {
        const card = document.createElement('div');
        card.className = 'edit-card';
        card.innerHTML = `
          <div class="array-item-header">
            <span class="array-item-title">${ending.icon || 'ğŸ“'} ${ending.name}</span>
            <div>
              <button class="btn btn-info btn-sm" onclick="editEnding(${index})">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="deleteEnding(${index})">åˆ é™¤</button>
            </div>
          </div>
          <div style="font-size: 12px; color: #666;">${ending.description}</div>
          <div style="font-size: 11px; color: #999; margin-top: 5px;">
            æ¡ä»¶: ${JSON.stringify(ending.condition)}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function openEndingModal(index = null) {
      editingEndingId = index;
      const modal = document.getElementById('ending-modal');
      const title = document.getElementById('ending-modal-title');
      const content = document.getElementById('ending-modal-content');
      
      title.textContent = index !== null ? 'ç¼–è¾‘ç»“å±€' : 'æ·»åŠ ç»“å±€';
      const ending = index !== null ? contentConfig.endings[index] : { id: generateId('ending'), name: '', description: '', condition: {}, icon: 'ğŸ“' };
      
      content.innerHTML = `
        <div class="form-group">
          <label>ç»“å±€ID</label>
          <input type="text" id="ending-id" value="${ending.id}" ${index !== null ? 'readonly' : ''}>
        </div>
        <div class="form-group">
          <label>ç»“å±€åç§°</label>
          <input type="text" id="ending-name" value="${ending.name || ''}">
        </div>
        <div class="form-group">
          <label>ç»“å±€æè¿°</label>
          <textarea id="ending-desc" style="min-height: 60px;">${ending.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label>å›¾æ ‡ (emoji)</label>
          <input type="text" id="ending-icon" value="${ending.icon || 'ğŸ“'}">
        </div>
        <div class="form-group">
          <label>è§¦å‘æ¡ä»¶ï¼ˆJSONï¼‰</label>
          <textarea id="ending-condition" style="min-height: 80px;">${JSON.stringify(ending.condition, null, 2)}</textarea>
          <div style="font-size: 11px; color: #666; margin-top: 5px;">
            ç¤ºä¾‹: {"type": "score", "field": "percentage", "operator": ">=", "value": 0.6}
          </div>
        </div>
        <div class="form-group">
          <label>è§£é”å­¦æ ¡ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="ending-school" value="${ending.unlockSchool || ''}">
        </div>
      `;
      modal.classList.add('active');
    }

    function saveEnding() {
      const id = document.getElementById('ending-id').value;
      const name = document.getElementById('ending-name').value;
      const description = document.getElementById('ending-desc').value;
      const icon = document.getElementById('ending-icon').value;
      const unlockSchool = document.getElementById('ending-school').value;
      
      let condition = {};
      try {
        condition = JSON.parse(document.getElementById('ending-condition').value || '{}');
      } catch (e) {
        showToast('æ¡ä»¶JSONæ ¼å¼é”™è¯¯', 'error');
        return;
      }
      
      const endingData = { id, name, description, icon, condition, ...(unlockSchool ? { unlockSchool } : {}) };
      
      if (editingEndingId !== null) {
        contentConfig.endings[editingEndingId] = endingData;
      } else {
        contentConfig.endings.push(endingData);
      }
      
      closeModal('ending-modal');
      renderEndingsSection();
      markUnsaved();
      showToast(editingEndingId !== null ? 'ç»“å±€å·²æ›´æ–°' : 'ç»“å±€å·²æ·»åŠ ', 'success');
    }

    function editEnding(index) { openEndingModal(index); }
    
    function deleteEnding(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»“å±€å—ï¼Ÿ')) {
        contentConfig.endings.splice(index, 1);
        renderEndingsSection();
        markUnsaved();
        showToast('ç»“å±€å·²åˆ é™¤', 'success');
      }
    }

    function renderHighschoolsSection() {
      const container = document.getElementById('highschools-list');
      container.innerHTML = '';
      const schools = contentConfig.highSchools?.data || [];
      
      if (schools.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ«</div><p>æš‚æ— å­¦æ ¡æ•°æ®</p></div>';
        return;
      }
      
      schools.sort((a, b) => b.admissionScore - a.admissionScore).forEach((school, index) => {
        const div = document.createElement('div');
        div.className = 'highschool-card';
        div.dataset.name = school.name.toLowerCase();
        div.innerHTML = `
          <span class="highschool-score">${school.admissionScore}åˆ†</span>
          <div class="highschool-info">
            <div class="highschool-name">${school.name} <span class="badge">${school.type}</span></div>
            <div class="highschool-features">${school.features?.join(' | ') || ''}</div>
          </div>
          <div>
            <button class="btn btn-info btn-sm" onclick="editHighschool(${index})">ç¼–è¾‘</button>
            <button class="btn btn-danger btn-sm" onclick="deleteHighschool(${index})">åˆ é™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function filterHighschools() {
      const query = document.getElementById('highschool-search').value.toLowerCase();
      document.querySelectorAll('.highschool-card').forEach(card => {
        card.style.display = card.dataset.name.includes(query) ? 'flex' : 'none';
      });
    }

    function openHighschoolModal(index = null) {
      editingHighschoolId = index;
      const modal = document.getElementById('highschool-modal');
      const title = document.getElementById('highschool-modal-title');
      const content = document.getElementById('highschool-modal-content');
      
      title.textContent = index !== null ? 'ç¼–è¾‘å­¦æ ¡' : 'æ·»åŠ å­¦æ ¡';
      const school = index !== null ? contentConfig.highSchools.data[index] : { name: '', type: 'å…¬åŠ', admissionScore: 500, features: [], description: '' };
      
      content.innerHTML = `
        <div class="form-group">
          <label>å­¦æ ¡åç§°</label>
          <input type="text" id="hs-name" value="${school.name || ''}">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å­¦æ ¡ç±»å‹</label>
            <select id="hs-type">
              <option value="å…¬åŠ" ${school.type === 'å…¬åŠ' ? 'selected' : ''}>å…¬åŠ</option>
              <option value="æ°‘åŠ" ${school.type === 'æ°‘åŠ' ? 'selected' : ''}>æ°‘åŠ</option>
            </select>
          </div>
          <div class="form-group">
            <label>å½•å–åˆ†æ•°</label>
            <input type="number" id="hs-score" value="${school.admissionScore || 500}">
          </div>
        </div>
        <div class="form-group">
          <label>ç‰¹è‰²æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input type="text" id="hs-features" value="${school.features?.join(', ') || ''}">
        </div>
        <div class="form-group">
          <label>å­¦æ ¡æè¿°</label>
          <textarea id="hs-desc" style="min-height: 60px;">${school.description || ''}</textarea>
        </div>
      `;
      modal.classList.add('active');
    }

    function saveHighschool() {
      const name = document.getElementById('hs-name').value;
      const type = document.getElementById('hs-type').value;
      const admissionScore = parseInt(document.getElementById('hs-score').value);
      const features = document.getElementById('hs-features').value.split(',').map(s => s.trim()).filter(s => s);
      const description = document.getElementById('hs-desc').value;
      
      const schoolData = { name, type, admissionScore, features, description };
      
      if (editingHighschoolId !== null) {
        contentConfig.highSchools.data[editingHighschoolId] = schoolData;
      } else {
        contentConfig.highSchools.data.push(schoolData);
      }
      
      closeModal('highschool-modal');
      renderHighschoolsSection();
      markUnsaved();
      showToast(editingHighschoolId !== null ? 'å­¦æ ¡å·²æ›´æ–°' : 'å­¦æ ¡å·²æ·»åŠ ', 'success');
    }

    function editHighschool(index) { openHighschoolModal(index); }
    
    function deleteHighschool(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦æ ¡å—ï¼Ÿ')) {
        contentConfig.highSchools.data.splice(index, 1);
        renderHighschoolsSection();
        markUnsaved();
        showToast('å­¦æ ¡å·²åˆ é™¤', 'success');
      }
    }

    function renderExamConfigSection() {
      const exam = contentConfig.examMechanics || {};
      const scoreCalc = exam.scoreCalculation || {};
      
      document.getElementById('base-score').value = scoreCalc.baseScore || 100;
      document.getElementById('difficulty-config').value = JSON.stringify(scoreCalc.difficulty || {}, null, 2);
      document.getElementById('bonus-config').value = JSON.stringify(scoreCalc.bonus || {}, null, 2);
      
      const timeLimitContainer = document.getElementById('time-limit-config');
      timeLimitContainer.innerHTML = '';
      const timeLimits = exam.timeLimit || {};
      ['monthly', 'midterm', 'final', 'mock', 'middle'].forEach(type => {
        timeLimitContainer.innerHTML += `
          <div class="form-group">
            <label>${getExamTypeName(type)} (åˆ†é’Ÿ)</label>
            <input type="number" data-exam-type="${type}" value="${timeLimits[type] || 90}" onchange="updateTimeLimit('${type}', this.value)">
          </div>
        `;
      });
      
      const weightContainer = document.getElementById('score-weight-config');
      weightContainer.innerHTML = '';
      const weights = exam.scoreWeight || {};
      ['monthly', 'midterm', 'final', 'mock', 'middle'].forEach(type => {
        weightContainer.innerHTML += `
          <div class="form-group">
            <label>${getExamTypeName(type)} æƒé‡</label>
            <input type="number" step="0.05" data-weight-type="${type}" value="${weights[type] || 0.1}" onchange="updateScoreWeight('${type}', parseFloat(this.value))">
          </div>
        `;
      });
      
      // æ¸²æŸ“ç»Ÿä¸€ç‚¹å‡»æ¬¡æ•°é™åˆ¶é…ç½®
      const clickLimitContainer = document.getElementById('click-limit-config');
      clickLimitContainer.innerHTML = '';
      const clickLimits = exam.clickLimit || {};
      // ä½¿ç”¨ç»Ÿä¸€ç‚¹å‡»æ¬¡æ•°è®¾ç½®ï¼Œä¸å†åŒºåˆ†è€ƒè¯•ç±»å‹
      const unifiedClickLimit = clickLimits.unified || Object.values(clickLimits)[0] || 33;
      clickLimitContainer.innerHTML += `
        <div class="form-group">
          <label>ç»Ÿä¸€è€ƒè¯•ç‚¹å‡»æ¬¡æ•°</label>
          <input type="number" step="1" id="unified-click-limit" value="${unifiedClickLimit}" onchange="updateUnifiedClickLimit(parseInt(this.value))">
        </div>
      `;
      
      const cancelCond = exam.cancelConditions || {};
      document.getElementById('cancel-weather').value = (cancelCond.weather || []).join(', ');
      document.getElementById('cancel-holiday').checked = cancelCond.holiday || false;
    }

    function getExamTypeName(type) {
      const names = { monthly: 'æœˆè€ƒ', midterm: 'æœŸä¸­', final: 'æœŸæœ«', mock: 'æ¨¡æ‹Ÿ', middle: 'ä¸­è€ƒ' };
      return names[type] || type;
    }

    function updateExamConfig(key, value) {
      if (!contentConfig.examMechanics) contentConfig.examMechanics = {};
      if (!contentConfig.examMechanics.scoreCalculation) contentConfig.examMechanics.scoreCalculation = {};
      contentConfig.examMechanics.scoreCalculation[key] = value;
      markUnsaved();
    }

    function updateDifficultyConfig() {
      try {
        const diff = JSON.parse(document.getElementById('difficulty-config').value);
        contentConfig.examMechanics.scoreCalculation.difficulty = diff;
        markUnsaved();
      } catch (e) { showToast('JSONæ ¼å¼é”™è¯¯', 'error'); }
    }

    function updateBonusConfig() {
      try {
        const bonus = JSON.parse(document.getElementById('bonus-config').value);
        contentConfig.examMechanics.scoreCalculation.bonus = bonus;
        markUnsaved();
      } catch (e) { showToast('JSONæ ¼å¼é”™è¯¯', 'error'); }
    }

    function updateTimeLimit(type, value) {
      if (!contentConfig.examMechanics) contentConfig.examMechanics = {};
      if (!contentConfig.examMechanics.timeLimit) contentConfig.examMechanics.timeLimit = {};
      contentConfig.examMechanics.timeLimit[type] = parseInt(value);
      markUnsaved();
    }

    function updateScoreWeight(type, value) {
      if (!contentConfig.examMechanics) contentConfig.examMechanics = {};
      if (!contentConfig.examMechanics.scoreWeight) contentConfig.examMechanics.scoreWeight = {};
      contentConfig.examMechanics.scoreWeight[type] = value;
      markUnsaved();
    }
    
    function updateUnifiedClickLimit(value) {
      if (!contentConfig.examMechanics) contentConfig.examMechanics = {};
      if (!contentConfig.examMechanics.clickLimit) contentConfig.examMechanics.clickLimit = {};
      // åªè®¾ç½®ç»Ÿä¸€ç‚¹å‡»æ¬¡æ•°ï¼Œä¸å†åŒºåˆ†è€ƒè¯•ç±»å‹
      contentConfig.examMechanics.clickLimit.unified = value;
      markUnsaved();
    }

    function updateCancelWeather() {
      const weather = document.getElementById('cancel-weather').value.split(',').map(s => s.trim()).filter(s => s);
      if (!contentConfig.examMechanics) contentConfig.examMechanics = {};
      if (!contentConfig.examMechanics.cancelConditions) contentConfig.examMechanics.cancelConditions = {};
      contentConfig.examMechanics.cancelConditions.weather = weather;
      markUnsaved();
    }

    function updateCancelHoliday() {
      const holiday = document.getElementById('cancel-holiday').checked;
      if (!contentConfig.examMechanics) contentConfig.examMechanics = {};
      if (!contentConfig.examMechanics.cancelConditions) contentConfig.examMechanics.cancelConditions = {};
      contentConfig.examMechanics.cancelConditions.holiday = holiday;
      markUnsaved();
    }

    function renderEffectsSection() {
      const container = document.getElementById('effects-list');
      container.innerHTML = '';
      
      for (const [key, config] of Object.entries(EFFECTS_CONFIG)) {
        const card = document.createElement('div');
        card.className = 'edit-card';
        card.innerHTML = `
          <div class="edit-card-title">âš¡ ${config.label} (${key})</div>
          <div style="font-size: 12px; color: #666;">
            <div>å¯ç”¨å­—æ®µ: ${config.fieldsList ? config.fieldsList.join(', ') : config.fields.join(', ')}</div>
            <div style="margin-top: 5px;">ç¤ºä¾‹æ•ˆæœ:</div>
            <pre style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 11px; overflow-x: auto;">${generateEffectExample(key, config)}</pre>
          </div>
        `;
        container.appendChild(card);
      }
    }

    function generateEffectExample(type, config) {
      const examples = {
        academic: '{"type": "academic", "subjects": ["math"], "value": 5}',
        abilities: '{"type": "abilities", "field": "focus", "value": 2}',
        status: '{"type": "status", "field": "energy", "value": -20}',
        special: '{"type": "special", "field": "mindset", "value": 5}',
        classmateship: '{"type": "classmateship", "value": 10}',
        club: '{"type": "club", "value": "math"}'
      };
      return examples[type] || '{}';
    }

    function renderQuotesSection() {
      const container = document.getElementById('quotes-list');
      container.innerHTML = '';
      
      const defaultQuotes = contentConfig.quotes?.default || [];
      
      document.getElementById('default-quotes-count').textContent = defaultQuotes.length;
      
      if (defaultQuotes.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><p>æš‚æ— é»˜è®¤è¯­å½•ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
        return;
      }
      
      defaultQuotes.forEach((quote, index) => {
        const card = document.createElement('div');
        card.className = 'edit-card';
        card.innerHTML = `
          <div class="array-item-header">
            <span class="array-item-title">ğŸ’¬ è¯­å½• #${index + 1}</span>
            <div>
              <button class="btn btn-info btn-sm" onclick="editQuote(${index}, 'default')">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="deleteQuote(${index}, 'default')">åˆ é™¤</button>
            </div>
          </div>
          <div style="font-size: 14px; color: #333; padding: 10px; background-color: #f8f9fa; border-radius: 6px;">${quote}</div>
        `;
        container.appendChild(card);
      });
      
      renderPreviewSection();
    }

    function openQuoteModal(index = null, type = 'default') {
      const modal = document.getElementById('quote-modal');
      const title = document.getElementById('quote-modal-title');
      const quotes = contentConfig.quotes?.default || [];
      const quote = index !== null ? quotes[index] : '';
      
      title.textContent = index !== null ? 'ç¼–è¾‘è¯­å½•' : 'æ·»åŠ è¯­å½•';
      document.getElementById('quote-content').value = quote;
      
      modal.dataset.editIndex = index !== null ? index : '';
      modal.classList.add('active');
    }

    function saveQuote() {
      const modal = document.getElementById('quote-modal');
      const content = document.getElementById('quote-content').value.trim();
      const editIndex = modal.dataset.editIndex;
      
      if (!content) {
        showToast('è¯­å½•å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }
      
      if (!contentConfig.quotes) {
        contentConfig.quotes = { default: [] };
      }
      if (!contentConfig.quotes.default) contentConfig.quotes.default = [];
      
      if (editIndex !== '') {
        contentConfig.quotes.default[parseInt(editIndex)] = content;
        showToast('è¯­å½•å·²æ›´æ–°', 'success');
      } else {
        contentConfig.quotes.default.push(content);
        showToast('è¯­å½•å·²æ·»åŠ ', 'success');
      }
      
      closeModal('quote-modal');
      renderQuotesSection();
      markUnsaved();
    }

    function editQuote(index, type) {
      openQuoteModal(index, 'default');
    }

    function deleteQuote(index, type) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯­å½•å—ï¼Ÿ')) {
        contentConfig.quotes.default.splice(index, 1);
        renderQuotesSection();
        markUnsaved();
        showToast('è¯­å½•å·²åˆ é™¤', 'success');
      }
    }

    function renderPreviewSection() {
      const upcomingContainer = document.getElementById('upcoming-events-preview-full');
      const statsContainer = document.getElementById('event-stats-full');
      const events = contentConfig.timeline?.events || [];
      const sorted = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));
      const today = '2022-09-01';
      const upcoming = sorted.filter(e => e.date >= today).slice(0, 3);
      
      const upcomingHTML = upcoming.length ? upcoming.map(e => `
        <div class="timeline-event-item">
          <span class="timeline-event-date">${e.date}</span>
          <span>${e.title}</span>
        </div>
      `).join('') : '<div style="color: #999;">æš‚æ— å³å°†åˆ°æ¥çš„äº‹ä»¶</div>';
      
      const typeCount = {};
      events.forEach(e => { typeCount[e.type] = (typeCount[e.type] || 0) + 1; });
      const statsHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
          <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #1976d2;">${events.length}</div>
            <div style="font-size: 12px; color: #666;">æ€»äº‹ä»¶æ•°</div>
          </div>
          <div style="background: #fff3e0; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #e65100;">${typeCount.key || 0}</div>
            <div style="font-size: 12px; color: #666;">å…³é”®äº‹ä»¶</div>
          </div>
          <div style="background: #fce4ec; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #c2185b;">${typeCount.exam || 0}</div>
            <div style="font-size: 12px; color: #666;">è€ƒè¯•äº‹ä»¶</div>
          </div>
          <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">${typeCount.holiday || 0}</div>
            <div style="font-size: 12px; color: #666;">å‡æœŸäº‹ä»¶</div>
          </div>
        </div>
      `;
      
      if (upcomingContainer) upcomingContainer.innerHTML = upcomingHTML;
      if (statsContainer) statsContainer.innerHTML = statsHTML;
      
      const quotesUpcomingContainer = document.getElementById('upcoming-events-preview');
      const quotesStatsContainer = document.getElementById('event-stats');
      if (quotesUpcomingContainer) quotesUpcomingContainer.innerHTML = upcomingHTML;
      if (quotesStatsContainer) quotesStatsContainer.innerHTML = statsHTML;
    }

    function updateGameInfo(field, value) {
      if (!contentConfig.game) contentConfig.game = {};
      contentConfig.game[field] = value;
      markUnsaved();
    }

    function generateId(prefix) {
      return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('section-' + sectionId).classList.add('active');
      event.target.closest('.nav-item').classList.add('active');
    }

    function markUnsaved() {
      isUnsaved = true;
      document.getElementById('status-dot').classList.add('unsaved');
      document.getElementById('status-text').textContent = 'æœªä¿å­˜';
      document.getElementById('config-count').textContent = countConfigObjects();
    }

    function countConfigObjects() {
      let count = 0;
      if (contentConfig.events?.random) count += contentConfig.events.random.length;
      if (contentConfig.timeline?.events) count += contentConfig.timeline.events.length;
      if (contentConfig.achievements) count += contentConfig.achievements.length;
      if (contentConfig.endings) count += contentConfig.endings.length;
      if (contentConfig.highSchools?.data) count += contentConfig.highSchools.data.length;
      return count;
    }

    function updateStatusBar() {
      document.getElementById('config-version').textContent = contentConfig.version || '1.0.0';
      document.getElementById('config-count').textContent = countConfigObjects();
    }

    function selectAllSubjects() {
      const checkboxes = document.querySelectorAll('input[name="subject-checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
    }

    function clearAllSubjects() {
      const checkboxes = document.querySelectorAll('input[name="subject-checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
    }

    function invertSelection() {
      const checkboxes = document.querySelectorAll('input[name="subject-checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = !checkbox.checked;
      });
    }

    function updateSubjectCheckboxes() {
      // æ ¹æ®è€ƒè¯•ç±»å‹è‡ªåŠ¨é€‰æ‹©ç›¸å…³ç§‘ç›®
      const examType = document.getElementById('timeline-examType').value;
      const subjectsByType = {
        'entry': ['chinese', 'math', 'english'], // å…¥å­¦è€ƒè¯•é€šå¸¸ä¸ºè¯­æ•°è‹±
        'monthly': ['chinese', 'math', 'english'], // æœˆè€ƒé€šå¸¸ä¸ºè¯­æ•°è‹±
        'midterm': ['chinese', 'math', 'english', 'politics', 'history'], // æœŸä¸­è€ƒè¯•
        'final': ['chinese', 'math', 'english', 'politics', 'history'], // æœŸæœ«è€ƒè¯•
        'biology_geography': ['biology', 'geography'], // ç”Ÿåœ°ä¼šè€ƒ
        'sports': ['sports'], // ä½“è‚²ä¸­è€ƒ
        'mock': ['chinese', 'math', 'english', 'politics', 'history', 'physics', 'chemistry', 'sports'], // æ¨¡æ‹Ÿè€ƒè¯•
        'middle': ['chinese', 'math', 'english', 'politics', 'history', 'physics', 'chemistry', 'sports'] // ä¸­è€ƒ
      };

      // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
      clearAllSubjects();

      // æ ¹æ®è€ƒè¯•ç±»å‹è‡ªåŠ¨é€‰æ‹©å¯¹åº”ç§‘ç›®
      if (subjectsByType[examType]) {
        subjectsByType[examType].forEach(subject => {
          const checkbox = document.querySelector(`input[name="subject-checkbox"][value="${subject}"]`);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
      }
    }

    async function saveConfig() {
      contentConfig.lastUpdated = new Date().toISOString().split('T')[0];
      
      try {
        const response = await fetch('http://127.0.0.1:5001/api/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(contentConfig)
        });
        
        const result = await response.json();
        
        if (result.success) {
          localStorage.setItem('lgb_content_config', JSON.stringify(contentConfig));
          
          isUnsaved = false;
          document.getElementById('status-dot').classList.remove('unsaved');
          document.getElementById('status-text').textContent = 'å·²ä¿å­˜';
          showToast('é…ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼', 'success');
          
          if (result.backup) {
            console.log('å¤‡ä»½å·²åˆ›å»º:', result.backup);
          }
        } else {
          showToast('ä¿å­˜å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜é…ç½®æ—¶å‡ºé”™:', error);
        showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¡®ä¿ç¼–è¾‘å™¨æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ', 'error');
      }
    }

    function exportConfig() {
      const blob = new Blob([JSON.stringify(contentConfig, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `content-config-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('é…ç½®å·²å¯¼å‡ºï¼', 'success');
    }

    function importConfig() {
      document.getElementById('import-file').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          contentConfig = JSON.parse(e.target.result);
          renderAllSections();
          markUnsaved();
          showToast('é…ç½®å·²å¯¼å…¥ï¼', 'success');
        } catch (err) {
          showToast('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function resetToDefault() {
      document.getElementById('reset-modal').classList.add('active');
    }

    function confirmReset() {
      contentConfig = getDefaultConfig();
      renderAllSections();
      closeModal('reset-modal');
      markUnsaved();
      showToast('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®', 'warning');
    }

    async function showBackups() {
      try {
        const response = await fetch('http://127.0.0.1:5001/api/backups');
        const result = await response.json();
        
        if (result.success) {
          const backupsList = document.getElementById('backups-list');
          
          if (result.data.length === 0) {
            backupsList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¤‡ä»½æ–‡ä»¶</p>';
          } else {
            backupsList.innerHTML = result.data.map(backup => `
              <div class="edit-card" style="margin-bottom: 10px;">
                <div class="array-item-header">
                  <span class="array-item-title">ğŸ“„ ${backup.filename}</span>
                  <div>
                    <button class="btn btn-info btn-sm" onclick="viewBackup('${backup.filename}')">æŸ¥çœ‹</button>
                    <button class="btn btn-success btn-sm" onclick="restoreBackup('${backup.filename}')">æ¢å¤</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.filename}')">åˆ é™¤</button>
                  </div>
                </div>
                <div style="font-size: 12px; color: #666;">
                  <div>åˆ›å»ºæ—¶é—´: ${backup.created}</div>
                  <div>æ–‡ä»¶å¤§å°: ${(backup.size / 1024).toFixed(2)} KB</div>
                </div>
              </div>
            `).join('');
          }
          
          document.getElementById('backups-modal').classList.add('active');
        } else {
          showToast('è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('è·å–å¤‡ä»½åˆ—è¡¨æ—¶å‡ºé”™:', error);
        showToast('è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¡®ä¿ç¼–è¾‘å™¨æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ', 'error');
      }
    }

    async function viewBackup(filename) {
      try {
        const response = await fetch(`http://127.0.0.1:5001/api/backup/${filename}`);
        const result = await response.json();
        
        if (result.success) {
          const backupData = JSON.stringify(result.data, null, 2);
          const newWindow = window.open('', '_blank');
          newWindow.document.write(`<pre style="white-space: pre-wrap; word-wrap: break-word;">${backupData}</pre>`);
          newWindow.document.close();
        } else {
          showToast('æŸ¥çœ‹å¤‡ä»½å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('æŸ¥çœ‹å¤‡ä»½æ—¶å‡ºé”™:', error);
        showToast('æŸ¥çœ‹å¤‡ä»½å¤±è´¥', 'error');
      }
    }

    async function restoreBackup(filename) {
      if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ "${filename}" å—ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ã€‚`)) {
        return;
      }
      
      try {
        const response = await fetch(`http://127.0.0.1:5001/api/backup/${filename}`, {
          method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
          contentConfig = result.data;
          renderAllSections();
          closeModal('backups-modal');
          markUnsaved();
          showToast('å¤‡ä»½å·²æ¢å¤', 'success');
        } else {
          showToast('æ¢å¤å¤‡ä»½å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('æ¢å¤å¤‡ä»½æ—¶å‡ºé”™:', error);
        showToast('æ¢å¤å¤‡ä»½å¤±è´¥', 'error');
      }
    }

    async function deleteBackup(filename) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤‡ä»½ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        return;
      }
      
      try {
        const response = await fetch(`http://127.0.0.1:5000/api/backup/${filename}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        
        if (result.success) {
          showBackups();
          showToast('å¤‡ä»½å·²åˆ é™¤', 'success');
        } else {
          showToast('åˆ é™¤å¤‡ä»½å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤å¤‡ä»½æ—¶å‡ºé”™:', error);
        showToast('åˆ é™¤å¤‡ä»½å¤±è´¥', 'error');
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    window.onclick = function(e) {
      if (e.target.classList.contains('modal')) e.target.classList.remove('active');
    };

    init();
  </script>
</body>

</html>
